<template lang="pug">
div
    //- NDataTable(:columns="columns" :data="datasets" :row-key="(row) => row.id" :pagination="pagination" @update-page="handlePageChange")
    NDataTable(remote :columns="columns" :data="datasets" :row-key="(row) => row.id" :pagination="pagination" @update-page="handlePageChange" :loading="loadingRef")
    // TODO - continue datatable
</template>

<script setup lang="ts">
import { h, onMounted, reactive, ref } from "vue";
import { NButton } from "naive-ui";
// import mockdataset from "../../utils/cveinfo.json"
import { useRoute, useRouter } from "vue-router";
import { datasetService } from "@/utils/services";
import type { DatasetSchema } from "@/api";

// const nono = mockdataset.RECORDS
const nono = []
const route = useRoute()
const router = useRouter()
const loadingRef = ref(true)


const handlePageChange = async (currentPage) => {
    loadingRef.value = true
    const offset = (currentPage - 1) * 20
    // TODO - dry here
    datasets.value = (await datasetService.getDatasets(true, offset, 20))
        .data.map((e) => {
            e.cve.publisheddate = e.cve.publisheddate.split('T')[0];
            return { ...e.cve, id: e.id }
        })
    pagination.page = currentPage
    loadingRef.value = false
}


const datasets = ref()
// datasets.value = (await datasetService.getDatasets(true, 0, 20))
//     .data.map((e) => {
//         e.cve.publisheddate = e.cve.publisheddate.split('T')[0];
//         return { ...e.cve, id: e.id }
//     })

const pagination = reactive({
    page: 1,
    pageCount: 1,
    pageSize: 10,
    itemCount: 999
})

onMounted(async () => {
    datasets.value = (await datasetService.getDatasets(true, 0, 20))
        .data.map((e) => {
            e.cve.publisheddate = e.cve.publisheddate.split('T')[0];
            return { ...e.cve, id: e.id }
        })

    pagination.itemCount = 999
    loadingRef.value = false
})

const columns = [
    {
        title: 'CVE编号',
        key: 'cve_no',
        width: 150
    },
    {
        title: '发布日期',
        key: 'publisheddate',
        width: 170
    },
    {
        title: '描述',
        key: 'description',
        ellipsis: true,
    },
    {
        title: '操作',
        key: 'actions',
        render(row: any) {
            return h(
                NButton,
                {
                    size: 'small',
                    onClick: () => { router.push({ name: 'DatasetDetail', params: { id: row.id } }) }
                },
                { default: () => '查看' }
            )
        },
        ellipsis: true,
        width: 150
    }
]

</script>