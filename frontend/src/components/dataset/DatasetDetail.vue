<template lang="pug">
div.px-20.h-32.flex.flex-wrap.space-x-16.items-center
    NSpace
        NTag(v-for="(category,index) in categories" :key="index" type="success" size="large" round) {{ category.text }} 快捷键 {{ index.toString() }}
div.px-20.pb-10.flex.flex-wrap
    AnnotationArea(v-for="annotation in model.annotations" :annotation="annotation")
button.bg-gray-50.w-10.h-10(@click="logv")
div.flex.flex-col
    div
        div div1
        div div1
    div
        div div2
        div div2
    div
        div div3
        button div3
</template>

<script setup lang="ts">
import { Annotation, Dataset, PartCategory } from "@/api";
import { annotationService, datasetService, partCategoryService, userService } from "@/utils/service";
import { computed, onMounted, reactive, ref, watch } from "@vue/runtime-core";
import hotkeys from 'hotkeys-js'
import Cookies from "js-cookie";
import { onBeforeRouteUpdate, useRoute } from "vue-router";
import { AnnotationSpan, AnnotationVModel } from "./annotation";
import AnnotationArea from "./AnnotationArea.vue";

const route = useRoute()

const props = defineProps<{
    id: string
}>()

const text = (await datasetService.datasetRead(props.id)).data.cve as any as { description: string | undefined }
let model = ref(new AnnotationVModel(text.description ?? "", props.id))
await model.value.fetchAnnotation()

onBeforeRouteUpdate(async (to, from) => {
    const text = (await datasetService.datasetRead(to.params["id"] as string)).data.cve as any as { description: string | undefined }
    model.value = new AnnotationVModel(text.description ?? "", to.params["id"] as string)
    await model.value.fetchAnnotation()
})

const { data: categories } = await partCategoryService.partCategoryList()

const logv = async (mouse: MouseEvent) => {
    // await model.value.addNewAnnotation(new AnnotationSpan(...model.value.cursorPosition, 2))
    console.log(model.value.annotations)
}


const setupKeys = () => {
    hotkeys('right,left,ctrl+right,ctrl+left,space,esc', function (event, handler) {
        model.value.cursorAction(handler.key)
    })
    hotkeys('1,2,3,4,5,6', function (event, handler) {
        model.value.addNewAnnotation(new AnnotationSpan(...model.value.cursorPosition, "cat" + handler.key))
    })
}

setupKeys()

</script>

