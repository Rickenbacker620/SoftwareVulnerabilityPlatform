<template lang="pug">
div.px-20.h-32.flex.flex-wrap.space-x-16.items-center
    NSpace
        NTag(v-for="(category,index) in categories" :key="index" type="success" size="large" round) {{ category.text }} 快捷键 {{ index.toString() }}
div.px-20.pb-10
    AnnotationArea(v-for="annotation in model.annotations" :annotation="annotation")
button.bg-gray-50.w-10.h-10(@click="logv")
</template>

<script setup lang="ts">
// import { Annotation, Dataset, PartCategory } from "@/api";
import { annotationService, datasetService, userService } from "@/utils/services";
import { computed, onMounted, reactive, ref, watch } from "@vue/runtime-core";
import hotkeys from 'hotkeys-js'
import { onBeforeRouteUpdate, useRoute } from "vue-router";
import { AnnotationSpan, AnnotationVModel } from "./annotation";
import AnnotationArea from "./AnnotationArea.vue";

// const route = useRoute()

const props = defineProps<{ id: number }>()

const { data: dataset } = await datasetService.getDataset(props.id)
let model = ref(new AnnotationVModel(dataset.cve.description ?? "", props.id))
await model.value.fetchAnnotation()

onBeforeRouteUpdate(async (to, from) => {
    const toDatasetId = parseInt(to.params["id"] as string)
    const { data: dataset } = (await datasetService.getDataset(toDatasetId))
    model.value = new AnnotationVModel(dataset.cve.description ?? "", toDatasetId)
    await model.value.fetchAnnotation()
})

const { data: categories } = await annotationService.getPartCategories()

const logv = async (mouse: MouseEvent) => {
    // await model.value.addNewAnnotation(new AnnotationSpan(...model.value.cursorPosition, 2))
    console.log(model.value.annotations)
}


const setupKeys = () => {
    hotkeys('right,left,ctrl+right,ctrl+left,space,esc', function (event, handler) {
        model.value.cursorAction(handler.key)
    })
    hotkeys('1,2,3,4,5,6', function (event, handler) {
        model.value.addNewAnnotation(new AnnotationSpan(...model.value.cursorPosition, "cat" + handler.key))
    })
}

setupKeys()

</script>

