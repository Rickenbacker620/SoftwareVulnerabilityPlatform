<template lang="pug">
div.px-20.h-32.flex.flex-wrap.space-x-16.items-center
    NSpace
        NTag(v-for="(category,index) in categories" :key="index" type="success" size="large" round) {{ category.text }} 快捷键 {{ index.toString() }}
div.px-20.pb-10.text-4xl.leading-loose
    AnnotationArea(v-for="annotation in model.annotations" :annotation="annotation")
button.bg-gray-50.w-10.h-10(@click="logv")
</template>

<script setup lang="ts">
import { datasetService } from "@/utils/service";
import { onMounted, reactive, Ref, ref } from "@vue/runtime-core";
import hotkeys from 'hotkeys-js'
import { useRoute } from "vue-router";
import { AnnotationSpan, AnnotationVModel, CategoryVModel } from "./annotation";
import AnnotationArea from "./AnnotationArea.vue";

const route = useRoute()

const text = (await datasetService.datasetRead(route.params["id"].toString())).data.cve as any as { description: string | undefined }
const model = reactive(new AnnotationVModel(text.description ?? ""))


const annotation1 = new AnnotationSpan(0, 6, 'cat1')
const annotation2 = new AnnotationSpan(13, 15, 'cat2')
const annotation3 = new AnnotationSpan(8, 10, 'cat3')

model.addAnnotation(annotation1, annotation2, annotation3)


const categories: CategoryVModel[] = [
    { name: "cat1", text: "产生原因" },
    { name: "cat2", text: "漏洞位置" },
    { name: "cat3", text: "发生情境" },
    { name: "cat4", text: "涉及版本" },
    { name: "cat5", text: "触发者" },
    { name: "cat6", text: "触发操作" },
    { name: "cat7", text: "漏洞后果" }
]


const categorySel = ref('')

const logv = (mouse: MouseEvent) => {
    console.log(model.cursorPosition)
    model.addNewAnnotation(new AnnotationSpan(...model.cursorPosition, "cat2"))
}


const setupKeys = () => {
    hotkeys('right,left,ctrl+right,ctrl+left,space,esc', function (event, handler) {
        model.cursorAction(handler.key)
    })
    hotkeys('1,2,3,4,5,6', function (event, handler) {
        model.addNewAnnotation(new AnnotationSpan(...model.cursorPosition, "cat" + handler.key))
    })
    hotkeys('l', function (event, handler) {
        console.log(categorySel.value)
    })
}
console.log(model.text)

// annotations.push(basetext)

onMounted(async () => {
    setupKeys()
    console.log(model.text)

    const annotation1 = new AnnotationSpan(0, 6, 'cat1')
    const annotation2 = new AnnotationSpan(13, 15, 'cat2')
    const annotation3 = new AnnotationSpan(8, 10, 'cat3')

    model.addAnnotation(annotation1)
    model.addAnnotation(annotation2)
    model.addAnnotation(annotation3)


    const categories: CategoryVModel[] = [
        { name: "cat1", text: "产生原因" },
        { name: "cat2", text: "漏洞位置" },
        { name: "cat3", text: "发生情境" },
        { name: "cat4", text: "涉及版本" },
        { name: "cat5", text: "触发者" },
        { name: "cat6", text: "触发操作" },
        { name: "cat7", text: "漏洞后果" }]


    const categorySel = ref('')

    const logv = (mouse: MouseEvent) => {
        console.log(model.cursorPosition)
        model.addNewAnnotation(new AnnotationSpan(...model.cursorPosition, "cat2"))
    }
    console.log(model.text)
}
)

</script>

