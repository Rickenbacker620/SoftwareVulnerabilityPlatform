<template lang="pug">
div.px-20.h-32.flex.flex-wrap.space-x-16.items-center
    NSpace
        NTag(v-for="(category,index) in categories" :key="index" type="success" size="large" round) {{ category.text }} 快捷键 {{ index.toString() }}
div.px-20.pb-10.flex.flex-wrap
    AnnotationArea(v-for="annotation in model.annotations" :annotation="annotation")
button.bg-gray-50.w-10.h-10(@click="logv")
</template>

<script setup lang="ts">
import { Annotation, Dataset, PartCategory } from "@/api";
import { annotationService, datasetService, partCategoryService, userService } from "@/utils/service";
import { computed, onMounted, reactive, ref, watch } from "@vue/runtime-core";
import hotkeys from 'hotkeys-js'
import Cookies from "js-cookie";
import { onBeforeRouteUpdate, useRoute } from "vue-router";
import { AnnotationSpan, AnnotationVModel, Cursor, fillPlain } from "./annotation";
import AnnotationArea from "./AnnotationArea.vue";

const route = useRoute()

const props = defineProps<{
    id: string
}>()


// const dataset = ref<Dataset>()
// const categories = ref<PartCategory[]>()
// const annotations = ref<Annotation[]>()

// const computedAnnotations = computed(() => {
//     fillPlain()
// })

// const modeld = reactive<{ dataset: Dataset, categories: PartCategory[], annotations: AnnotationSpan[] }>
//     (await getDetail(props.id))

// const textd = computed(() => (modeld.dataset.cve as any).description)

const categorySel = ref('')



// const annotations = computed(() => {
//     let temp: AnnotationSpan[]
//     switch (cursor.value.mode) {
//         case "none":
//             temp = modeld.annotations
// break;
//         case "pending":
//             temp =

// break;
//         case "select":

// break;

//         default:
// break;
//     }
// fillPlain(modeld.annotations,)
// })


// async function getDetail(id: string) {
//     return {
//         dataset: (await datasetService.datasetRead(id)).data,
//         categories: (await partCategoryService.partCategoryList(id)).data,
//         annotations: ((await annotationService.annotationList(id)).data).map(e => new AnnotationSpan(e.start_offset, e.end_offset, e.part))
//     }
// }

// const  canAddAnnotation = ref(true)

// const cursor = ref(new Cursor(textd.value))

// const annotationWithCursor = computed(() =>{
//     const cursorspan = new AnnotationSpan(...cursor.value.position, cursor.value.mode)
//     const copy = [...modeld.annotations];
//     const temp = copy.filter(
//         e => e.start > cursorspan.start || e.end < cursorspan.end
//     );
//     canAddAnnotation.value = temp.length === copy.length ? true : false;
//     temp.push(cursorspan);
//     temp.sort((a, b) => a.start - b.start);
//     return temp;
// })

// const getdetail = async (id: string) => {
//     modeld.dataset = (await datasetservice.datasetread(id)).data
//     modeld.categories = (await partcategoryservice.partcategorylist(id)).data
//     modeld.annotations = (await annotationservice.annotationlist(id)).data
// }

// await getDetail(props.id)

const text = (await datasetService.datasetRead(route.params["id"].toString())).data.cve as any as { description: string | undefined }
let model = ref(new AnnotationVModel(text.description ?? "", parseInt(route.params["id"] as string)))
model.value.fetchAnnotation(route.params.id as string)


onBeforeRouteUpdate(async (to, from) => {
    to.params["id"]
    const text = (await datasetService.datasetRead(to.params["id"].toString())).data.cve as any as { description: string | undefined }
    model.value = new AnnotationVModel(text.description ?? "", parseInt(to.params["id"] as string))
    model.value.fetchAnnotation(route.params.id as string)
})

// console.log(made.text)


// watch(
//   () => route.params,
//   async newParams => {
//     userData.value = await fetchUser(newParams.id)
//   }
// )


const { data: categories } = await partCategoryService.partCategoryList()
// console.log(data)
// const categories: CategoryVModel[] = [
//     { name: "cat1", text: "产生原因" },
//     { name: "cat2", text: "漏洞位置" },
//     { name: "cat3", text: "发生情境" },
//     { name: "cat4", text: "涉及版本" },
//     { name: "cat5", text: "触发者" },
//     { name: "cat6", text: "触发操作" },
//     { name: "cat7", text: "漏洞后果" }
// ]


const logv = async (mouse: MouseEvent) => {
    await model.value.addNewAnnotation(new AnnotationSpan(...model.value.cursorPosition, 2))
    console.log(Cookies.get('csrftoken'))


    // axios.get("http://127.0.0.1:12377/v1/dataset")
    // console.log(model.cursorPosition)
    // model.addNewAnnotation(new AnnotationSpan(...model.cursorPosition, "cat2"))
    // annotationService.annotationCreate({ start_offset: 22, end_offset: 23, user: 1, dataset: 1, part: 1, detail: 1 })
    // console.log(model._annotations)
}


const setupKeys = () => {
    hotkeys('right,left,ctrl+right,ctrl+left,space,esc', function (event, handler) {
        model.value.cursorAction(handler.key)
    })
    hotkeys('1,2,3,4,5,6', function (event, handler) {
        model.value.addNewAnnotation(new AnnotationSpan(...model.value.cursorPosition, "cat" + handler.key))
    })
    hotkeys('l', function (event, handler) {
        console.log(categorySel.value)
    })
}
console.log(model.value.text)

// annotations.push(basetext)

// onMounted(async () => {
setupKeys()

</script>

