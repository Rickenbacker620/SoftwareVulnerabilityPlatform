<template lang="pug">
div.grid.grid-cols-5
    div.col-span-4.px-4
        div.h-32.flex.flex-wrap.space-x-16.items-center
            NSpace
                NTag(v-for="category in categories" :key="category.id" type="success" size="large" round ) {{ category.text }} 快捷键 {{ category.id }}
        div.pb-10
            AnnotationArea(v-for="annotation in model.annotations" :key="annotation.start" :annotation="annotation" @click="handleClick(annotation)")
        //- button.bg-gray-50.w-10.h-10(@click="logv")

    div.flex.flex-col.col-span-1.px-5.space-y-3.items-center.mt-10
        button.bg-green-700.h-8.w-20(@click="finishAnnotation") 完成标注
        MetaDataPanel(:metadata="dataset?.cve")
        SelectAnnotationPanel(v-if="selAnnotation" :sel-annotation="selAnnotation")
        button.bg-red-700.h-8.w-20(v-if="selAnnotation" @click="deleteAnnotation") 删除


</template>

<script setup lang="ts">
// import { Annotation, Dataset, PartCategory } from "@/api";
import type { DatasetDetailSchema } from "@/api";
import { annotationService, datasetService, userService } from "@/utils/services";
import { computed, onMounted, reactive, ref, watch } from "@vue/runtime-core";
import hotkeys from 'hotkeys-js'
import { onBeforeRouteUpdate, useRoute } from "vue-router";
import { AnnotationSpan, AnnotationVModel, BaseSpan } from "./annotation";
import AnnotationArea from "./AnnotationArea.vue";
import MetaDataPanel from "@/components/dataset/MetaDataPanel.vue"
import SelectAnnotationPanel from "./SelectAnnotationPanel.vue";
import { useMessage } from "naive-ui";


// const route = useRoute()

const selAnnotation = ref<{ id: number, text: string, part_catgory: string, detail_category: string }>()

const dataset = ref<DatasetDetailSchema>()

const handleClick = (span: BaseSpan) => {
    if (span instanceof AnnotationSpan) {
        console.log(categories)
        selAnnotation.value = { id: span.id, text: span.text || "", part_catgory: categories[span.part_id - 1].text || "", detail_category: "无" }
    }
}

const finishAnnotation = async () => {
    await datasetService.finishAnnotation(dataset.value!.id)
    message.success("已完成标注")
}

const message = useMessage()
const deleteAnnotation = async () => {
    const id = selAnnotation.value!.id
    try {
        const { data } = await annotationService.deleteAnnotation(id)
        message.success(data.message)
        selAnnotation.value = undefined
        model.value.removeAnnotation(id)
    } catch (error) {
        message.error("Failed to Delete")
    }
}

const props = defineProps<{ id: number }>()

const { data } = await datasetService.getDataset(props.id)
dataset.value = data

let model = ref(new AnnotationVModel(dataset.value.cve.description ?? "", props.id))
await model.value.fetchAnnotation()


onBeforeRouteUpdate(async (to, from) => {
    const toDatasetId = parseInt(to.params["id"] as string)
    const { data } = (await datasetService.getDataset(toDatasetId))
    dataset.value = data
    model.value = new AnnotationVModel(dataset.value.cve.description ?? "", toDatasetId)
    await model.value.fetchAnnotation()
    selAnnotation.value = undefined
})

const { data: categories } = await annotationService.getPartCategories()

const logv = async (mouse: MouseEvent) => {
    // await model.value.addNewAnnotation(new AnnotationSpan(...model.value.cursorPosition, 2))
    console.log(selAnnotation.value)
}



const setupKeys = () => {
    hotkeys('right,left,ctrl+right,ctrl+left,space,esc', function (event, handler) {
        event.preventDefault()
        model.value.cursorAction(handler.key)
    })

    hotkeys('1,2,3,4,5,6', function (event, handler) {
        model.value.addNewAnnotation({
            start_offset: model.value.cursorPosition[0],
            end_offset: model.value.cursorPosition[1],
            dataset_id: props.id,
            part_id: parseInt(handler.key)
        })
    })
}

setupKeys()

</script>

