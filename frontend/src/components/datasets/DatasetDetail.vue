<template lang="pug">
div.grid.grid-cols-5
    div.col-span-4.px-4
        div.h-32.flex.flex-wrap.space-x-16.items-center
            NSpace
                NTag(v-for="value,key in en2zh" :key="key" type="success" size="large" round ) {{ value[1] }} 快捷键 {{ key+1 }}
        div.pb-10
            AnnotationArea(
                v-for="annotation in annotationsView"
            :key="annotation.start"
            :text="grepText(annotation)"
            :part="annotation.part"
            :partzh="tozh(annotation.part)"
            @click="handleClick(annotation)")
        //- button.bg-gray-50.w-10.h-10(@click="logv")

    div.flex.flex-col.col-span-1.px-5.space-y-3.items-center.mt-10
        SelectAnnotationPanel(v-if="selAnnotation" :part="selAnnotation.part")
        button.bg-red-700.h-8.w-20(v-if="selAnnotation" @click="deleteAnnotation") 删除


</template>

<script setup lang="ts">
import type { DatasetDetailSchema } from "@/api";
import { annotationService, datasetService } from "@/utils/services";
import { computed, ref } from "@vue/runtime-core";
import hotkeys from 'hotkeys-js'
import AnnotationArea from "@/components/datasets/AnnotationArea.vue";
import { useMessage } from "naive-ui";
import { annotationWithCursor, fillIntervals, simplifyDate } from "@/utils/others";
import { useCursorStore } from "@/stores/cursor";
import SelectAnnotationPanel from "@/components/datasets/SelectAnnotationPanel.vue";
import _ from "lodash-es";

const message = useMessage()

const props = defineProps<{ id: string }>()


const en2zh = [
  ["cause", "产生原因"],
  ["location", "漏洞位置"],
  ["situation", "发生情境"],
  ["version", "涉及版本"],
  ["attacker", "触发者" ],
  ["operation", "触发操作"],
  ["consequence", "漏洞后果"]
]

const tozh = (en) => {
    const pair = _.find(en2zh,function(e) {return e[0] == en}) ?? []
    return pair[1]
}


const grepText = e => dataset.value.description.slice(e.start_offset, e.end_offset)

const annotationsView = computed(() => {
    const annotationsRaw = dataset.value.annotations ?? []
    let withCursor;
    switch (cursor.mode) {
        case "none":
            return fillIntervals(annotationsRaw, dataset.value.description.length)
        case "pending":
            withCursor = annotationWithCursor(annotationsRaw, cursor.position, cursor.mode)
            return fillIntervals(withCursor, dataset.value.description.length)
        case "select":
            withCursor = annotationWithCursor(annotationsRaw, cursor.position, cursor.mode)
            return fillIntervals(withCursor, dataset.value.description.length)
        default:
            return fillIntervals(annotationsRaw, dataset.value.description.length)
    }
})

const query = () => {
    return datasetService.getDataset(props.id)
        .then(res => res.data)
        .then(data => simplifyDate(data))
}

const selAnnotation = ref()

const handleClick = e => {
    if (!["pending", "select", "plain"].includes(e.part)) {
        selAnnotation.value = e
    }
}

const dataset = ref<DatasetDetailSchema>(await query())
dataset.value.annotations?.sort((a, b) => a.start_offset - b.end_offset);

const cursor = useCursorStore()
cursor.initialize(dataset.value.description)

const deleteAnnotation = () => {
    annotationService.deleteAnnotation(
        props.id,
        selAnnotation.value)
        .then(_ => message.success("删除成功"))
        .catch(_ => message.error("删除失败"))
    _.pull(dataset.value?.annotations ?? [], selAnnotation.value)
    selAnnotation.value = undefined
}


const setupKeys = () => {
    hotkeys.unbind()
    hotkeys('right,left,ctrl+right,ctrl+left,space,esc', function (event, handler) {
        event.preventDefault()
        switch (handler.key) {
            case 'right':
                cursor.move("right", 1)
                break;
            case 'left':
                cursor.move("left", 1)
                break
            case 'ctrl+right':
                cursor.move("right", 5);
                break
            case 'ctrl+left':
                cursor.move("left", 5);
                break
            case 'space':
                cursor.hoistCursor();
                break
            case 'esc':
                cursor.lowerCursor();
                break
            default:
                break;
        }
    })

    hotkeys('1,2,3,4,5,6,7', function (event, handler) {
        if (cursor.mode != "select")
            return
        const index = parseInt(handler.key) - 1
        const part = en2zh[index][0]
        const newAnnotation = {
            start_offset: cursor.position[0],
            end_offset: cursor.position[1],
            part: part
        }
        annotationService.createAnnotation(
            props.id,
            newAnnotation
        )
            .then(_ => message.success("添加成功"))
            .catch(_ => message.error("添加失败"))
        dataset.value.annotations?.push(newAnnotation)
        dataset.value.annotations?.sort((a, b) => a.start_offset - b.end_offset);
        cursor.afterAnnotationIndex()
    })
}

setupKeys()

</script>

