<template lang="pug">
NCollapse(accordion)
    NCollapseItem(v-for="task in tasks" :key="task.name")
        template(#header-extra) {{ task.created_at.toLocaleString("zh-CN") }}
        template(v-if="!user.username.startsWith('user')" #header) {{ task.name }}  | 进度 {{ calcProgress(task.detail) }}
        template(v-else #header) {{ task.name }}  | 进度 {{ calcProgressClassify(task.detail) }}
        NList.ml-5
            NListItem.text-center(v-for="dataset in task.detail")
                template(#prefix)
                    NIcon(v-if="!user.username.startsWith('user')" :color="(dataset.annotated || dataset.invalid) ? '#397e36' : '#a52a2a'")
                        CheckmarkFilled
                    NIcon(v-else :color="(dataset.classified) ? '#397e36' : '#a52a2a'")
                        CheckmarkFilled
                div.text-left
                    span.mr-10 {{ dataset.cve_id }}
                    span 上次修改 {{ new Date(dataset.modified_at ?? "").toLocaleString("zh-CN") }}
                template(#suffix)
                    NButton(size="small" @click="handleClick(task.detail, dataset.cve_id)") 标注
</template>

<script setup lang="ts">
import { datasetService } from "@/utils/services"
import {
    NButton,
    NCollapse,
    NCollapseItem,
    NIcon,
    NList,
    NListItem,
} from "naive-ui"
import { CheckmarkFilled } from "@vicons/carbon"
import { useRoute, useRouter } from "vue-router"
import { useDatasetsStore } from "@/stores/datasets"
import type { DatasetSchema } from "@/api"
import { useUserStore } from "@/stores/user"

const user = useUserStore()

const { data } = await datasetService.getMyTask()
const tasks = data.map((e) => {
    return {
        name: e.name,
        detail: e.detail,
        created_at: new Date(e.created_at),
    }
})

const calcProgress = (datasets: DatasetSchema[]) => {
    const part = datasets.reduce((prev, cur) =>
        (cur.annotated || cur.invalid) ?
            { total: prev.total + 1, annotated: prev.annotated + 1 } :
            { total: prev.total + 1, annotated: prev.annotated }, { total: 0, annotated: 0 })
    return `${part.annotated}/${part.total}`
}

const calcProgressClassify = (datasets: DatasetSchema[]) => {
    const part = datasets.reduce((prev, cur) =>
        (cur.classified) ?
            { total: prev.total + 1, classified: prev.classified + 1 } :
            { total: prev.total + 1, classified: prev.classified }, { total: 0, classified: 0 })
    return `${part.classified}/${part.total}`
}


const router = useRouter()
const route = useRoute()
const datasetsStore = useDatasetsStore()

const handleClick = (list, id) => {
    datasetsStore.initialize(
        list.map((e) => e.cve_id),
        id,
    )
    router.push({ name: "DatasetDetail", params: { id: id } })
    datasetsStore.savePrevPage(route.fullPath)
}
</script>
