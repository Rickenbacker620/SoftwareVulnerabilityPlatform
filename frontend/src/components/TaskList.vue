<template lang="pug">
NCollapse(accordion :default-expanded-names="[0]")
    NCollapseItem(v-for="task, index in tasks" :key="task.name" :name="index")
        template(#header-extra) {{ task.created_at.toLocaleString("zh-CN") }}
        template(v-if="task.task_type === 'annotate'" #header) {{ task.name }} || {{task.type_zh}} || 进度 {{ calcProgress(task.detail) }}
        template(v-if="task.task_type === 'classify'" #header) {{ task.name }} || {{task.type_zh}} || 进度 {{ calcProgressClassify(task.detail) }}
        NList.ml-5
            NListItem.text-center(v-for="dataset in task.detail")
                template(#prefix)
                    NIcon(v-if="task.task_type === 'annotate'" :color="(dataset?.tags?.includes('annotated') || dataset?.tags?.includes('invalid')) ? '#397e36' : '#a52a2a'")
                        CheckmarkFilled
                    NIcon(v-if="task.task_type === 'classify'" :color="(dataset?.tags?.includes('classified') || dataset?.tags?.includes('approved')) ? '#397e36' : '#a52a2a'")
                        CheckmarkFilled
                div.text-left
                    span.mr-10 {{ dataset.cve_id }}
                    span 上次修改 {{ new Date(dataset.modified_at ?? "").toLocaleString("zh-CN") }}
                template(#suffix)
                    NButton(size="small" @click="handleClick(task.detail, dataset.cve_id)") 标注
</template>

<script setup lang="ts">
import { datasetService, taskService } from "@/utils/services"
import {
    NButton,
    NCollapse,
    NCollapseItem,
    NIcon,
    NList,
    NListItem,
} from "naive-ui"
import { CheckmarkFilled } from "@vicons/carbon"
import { useRoute, useRouter } from "vue-router"
import { useDatasetsStore } from "@/stores/datasets"
import { useUserStore } from "@/stores/user"

const user = useUserStore()

const { data } = await taskService.getMyTask()

const taskTypeDict = {
    classify: "分类",
    annotate: "标注",
}

const tasks = data.map((e) => {
    return {
        name: e.name,
        detail: e.detail.sort((a, b) => {
            if (a.cve_id < b.cve_id) return -1
            if (a.cve_id > b.cve_id) return 1
            return 0
        }),
        task_type: e.task_type,
        type_zh: taskTypeDict[e.task_type] + "任务",
        created_at: new Date(e.created_at),
    }
})

const calcProgress = (datasets: DatasetSchema[]) => {
    const part = datasets.reduce(
        (prev, cur) =>
            cur.tags?.includes("annotated") || cur.tags?.includes("invalid")
                ? { total: prev.total + 1, annotated: prev.annotated + 1 }
                : { total: prev.total + 1, annotated: prev.annotated },
        { total: 0, annotated: 0 },
    )
    return `${part.annotated}/${part.total}`
}

const calcProgressClassify = (datasets: DatasetSchema[]) => {
    const part = datasets.reduce(
        (prev, cur) =>
            cur.tags?.includes("classified") || cur.tags?.includes("approved")
                ? { total: prev.total + 1, classified: prev.classified + 1 }
                : { total: prev.total + 1, classified: prev.classified },
        { total: 0, classified: 0 },
    )
    return `${part.classified}/${part.total}`
}

const router = useRouter()
const route = useRoute()
const datasetsStore = useDatasetsStore()

const handleClick = (list, id) => {
    datasetsStore.initialize(
        list.map((e) => e.cve_id),
        id,
    )
    router.push({ name: "DatasetDetail", params: { id: id } })
    datasetsStore.savePrevPage(route.fullPath)
}
</script>
