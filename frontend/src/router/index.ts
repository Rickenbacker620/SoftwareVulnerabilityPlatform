import { RouteRecordRaw, createRouter, createWebHistory } from "vue-router"
import DatasetDetail from "@/pages/DatasetDetail.vue"
import DatasetList from "@/pages/DatasetList.vue"
import TaskList from "@/components/TaskList.vue"
import TaskAssign from "@/components/TaskAssign.vue"
import Login from "@/pages/Login.vue"
import Home from "@/pages/Home.vue"
import Stats from "@/pages/Stats.vue"
import { useUserStore } from "@/stores/user"

const routes: Array<RouteRecordRaw> = [
    {
        path: "/",
        name: "Home",
        component: Home,
        children: [
            {
                path: "/datasets",
                name: "DatasetList",
                component: DatasetList,
            },
            {
                path: "/task",
                name: "TaskList",
                component: TaskList,
            },
            {
                path: "/task-assign",
                name: "TaskAssign",
                component: TaskAssign,
            },
            {
                path: "/stats",
                name: "Stats",
                component: Stats,
            },
        ],
    },
    {
        path: "/dataset/:id",
        name: "DatasetDetail",
        component: DatasetDetail,
        props: (route) => ({ id: route.params.id as string }),
    },
    {
        path: "/user/login",
        name: "Login",
        component: Login,
    },
]

const router = createRouter({
    history: createWebHistory(),
    routes,
})

router.beforeEach(async (to, from, next) => {
    const token = localStorage.getItem("token")
    if (token) {
        const user = useUserStore()
        await user.getUserInfo()
    }
    if (to.name !== "Login" && !token) next({ name: "Login" })
    else next()
})

export default router
