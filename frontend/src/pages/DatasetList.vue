<template lang="pug">
div.space-y-4
    NInput(placeholder="搜索" v-model:value="queryOptions.q" @update-value="testQuery")
    NDataTable(
        remote
        :columns="columns"
        :data="datasets"
        :row-key="(row) => row.cve_id"
        :pagination="pagination"
        :loading="loading"
        @update-page="handlePageChange"
        @update-filters="handleFilterChange"
        @update:sorter="handleSorterChange")
</template>

<script setup lang="ts">
import { computed, h, onMounted, reactive, ref } from "vue"
import { NButton, NIcon } from "naive-ui"
import { useRouter } from "vue-router"
import { datasetService } from "@/utils/services"
import { CheckmarkFilled, HelpFilled, WarningFilled } from "@vicons/carbon"
import { simplifyDate } from "@/utils/others"

const router = useRouter()
const datasets = ref()
const loading = ref(true)

const queryOptions = reactive({
    annotated: true,
    approved: undefined,
    ambiguous: undefined,
    order: false,
    limit: 10,
    offset: 0,
    q: "",
})

const pagination = reactive({
    page: 1,
    pageCount: 1,
    pageSize: 10,
    itemCount: 999,
})

const dateColumn = reactive({
    title: "标注日期",
    key: "modified_at",
    width: 190,
    sorter: true,
    sortOrder: computed(() => queryOptions.order),
})

const statusColumn = reactive({
    title: "状态",
    key: "status",
    render(row) {
        const iconArr: any[] = []
        if (row.approved === true) {
            iconArr.push(
                h(
                    NIcon,
                    { color: "#397e36", size: 20 },
                    { default: () => h(CheckmarkFilled) },
                ),
            )
        }
        if (row.ambiguous === true) {
            iconArr.push(
                h(
                    NIcon,
                    { color: "#cab05c", size: 20 },
                    { default: () => h(HelpFilled) },
                ),
            )
        }
        if (row.annotated === true) {
            iconArr.push(
                h(
                    NIcon,
                    { color: "#448faf", size: 20 },
                    { default: () => h(WarningFilled) },
                ),
            )
        }
        return iconArr
    },
    width: 100,
    filter: true,
    filterOptionValues: [],
    filterOptions: [
        {
            label: "已标注",
            value: "annotated",
        },
        {
            label: "已审核",
            value: "approved",
        },
        {
            label: "存疑",
            value: "ambiguous",
        },
    ],
})

const testQuery = async ([v1, vw]) => {
    console.log(queryOptions.q)
    console.log(v1)
    console.log(vw)
}

const query = (options) => {
    const order = options.order === (false || "descend") ? 1 : 0
    return datasetService
        .getDatasets(
            options.annotated,
            options.ambiguous,
            options.approved,
            order,
            options.q,
            options.offset,
            options.limit,
        )
        .then((res) => res.data)
        .then((data) => data.map(simplifyDate))
}

const handlePageChange = async (currentPage) => {
    loading.value = true

    const offset = (currentPage - 1) * queryOptions.limit
    queryOptions.offset = offset
    datasets.value = await query(queryOptions)
    pagination.page = currentPage

    loading.value = false
}

const handleSorterChange = async (sorter) => {
    loading.value = true

    queryOptions.order = !sorter ? false : sorter.order
    datasets.value = await query(queryOptions)

    loading.value = false
}

const handleFilterChange = async (filter) => {
    loading.value = true

    const filterValues = filter.status
    queryOptions.approved = filterValues.includes("approved")
    queryOptions.ambiguous = filterValues.includes("ambiguous")
    queryOptions.annotated = filterValues.includes("annotated")
    datasets.value = await query(queryOptions)

    statusColumn.filterOptionValues = filter.filterValues

    loading.value = false
}

loading.value = true

onMounted(async () => {
    datasets.value = await query(queryOptions)
    pagination.itemCount = 999
    loading.value = false
})

const columns: any[] = [
    {
        title: "CVE编号",
        key: "cve_id",
        width: 150,
    },
    dateColumn,
    {
        title: "描述",
        key: "description",
        ellipsis: true,
    },
    statusColumn,
    {
        title: "操作",
        key: "actions",
        render(row: any) {
            return h(
                NButton,
                {
                    size: "small",
                    onClick: () => {
                        const route = router.resolve({
                            name: "DatasetDetail",
                            params: { id: row.cve_id },
                        })
                        window.open(route.href)
                    },
                },
                { default: () => "查看" },
            )
        },
        ellipsis: true,
        width: 150,
    },
]
</script>
