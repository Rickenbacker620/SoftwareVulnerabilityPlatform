<template lang="pug">
div.space-y-4
    div.flex.flex-row.space-x-2.items-center
        div.flex-shrink-0 包含
        NSelect(:options="StatusFilterOptions" @update-value="handleFilterChange(true, $event)" multiple :default-value="['annotated']")
        div.flex-shrink-0 不包含
        NSelect(:options="StatusFilterOptions" @update-value="handleFilterChange(false, $event)" multiple)
    NInput(placeholder="搜索" v-model:value="queryOptions.q")
    NDataTable(
        remote
        :columns="columns"
        :data="datasets?.list"
        :row-key="(row) => row.cve_id"
        :pagination="pagination"
        :loading="loading"
        @update-page="handlePageChange"
        @update:sorter="handleSorterChange")
</template>

<script setup lang="ts">
import { computed, h, onMounted, reactive, ref, watch, watchEffect } from "vue"
import { NButton, NInputNumber, NSelect, NTag } from "naive-ui"
import { useRouter } from "vue-router"
import { datasetService } from "@/utils/services"
import { simplifyDate } from "@/utils/others"

const router = useRouter()
const datasets = ref()
const loading = ref(true)

const StatusFilterOptions = [
    { label: "标注", value: "annotated" },
    { label: "通过", value: "approved" },
    { label: "无效", value: "invalid" },
    { label: "存疑", value: "ambiguous" },
    { label: "示例", value: "example" },
    { label: "分类", value: "classified" },
]

const queryOptions = reactive({
    annotated: true,
    ambiguous: undefined,
    approved: undefined,
    invalid: undefined,
    classified: undefined,
    example: undefined,
    order: undefined,
    limit: 10,
    offset: 0,
    q: "",
})

const pagination = reactive({
    page: 1,
    pageCount: 0,
    pageSize: 10,
    itemCount: 0,
    prefix({ itemCount }) {
        return `共 ${itemCount} 条`
    },
})

const statusColumn = reactive({
    title: "状态",
    key: "status",
    render(row) {
        const tagsDict = {
            annotated: { zh: "标注", color: "#0050b3" },
            ambiguous: { zh: "存疑", color: "#876800" },
            approved: { zh: "通过", color: "#135200" },
            invalid: { zh: "无效", color: "#820014" },
            example: { zh: "示例", color: "#c41d7f" },
            classified: { zh: "分类", color: "#531dab" },
        }
        const tags = row.tags.map((tagKey) => {
            return h(
                NTag,
                {
                    style: {
                        "border-bottom": "7px solid" + tagsDict[tagKey].color,
                        marginRight: "6px",
                    },
                },
                { default: () => tagsDict[tagKey].zh },
            )
        })
        return tags
    },
})

const log = () => {
    console.log(queryOptions.q)
}

watch(queryOptions, async (q, prevQ) => {
    loading.value = true
    datasets.value = await query(q)
    pagination.itemCount = datasets.value?.count ?? 0
    loading.value = false
})

const query = (options) => {
    return datasetService
        .getDatasets(
            options.annotated,
            options.ambiguous,
            options.approved,
            options.invalid,
            options.example,
            options.classified,
            options.order,
            options.q,
            options.offset,
            options.limit,
        )
        .then((res) => res.data)
        .then((data) => {
            data.list.map((e) => {
                e.modified_at = simplifyDate(e.modified_at)
                return e
            })
            return data
        })
}

const handlePageChange = async (currentPage) => {
    const offset = (currentPage - 1) * queryOptions.limit
    queryOptions.offset = offset
    pagination.page = currentPage
}

const handleSorterChange = async (sorter) => {
    if (sorter.order == false) queryOptions.order = undefined
    else if (sorter.order === "ascend") queryOptions.order = 0
    else queryOptions.order = 1
    console.log(queryOptions.order)
    console.log(sorter)
}

const handleFilterChange = (type: boolean, value: string[]) => {
    for (const property in queryOptions) {
        if (value.includes(property)) {
            queryOptions[property] = type
        } else {
            if (queryOptions[property] === type) {
                queryOptions[property] = undefined
            }
        }
    }
}

loading.value = true

onMounted(async () => {
    datasets.value = await query(queryOptions)
    pagination.itemCount = datasets.value?.count ?? 0
    loading.value = false
})

const columns: any[] = [
    {
        title: "CVE编号",
        key: "cve_id",
        sorter: true,
        sortOrder: computed(() => queryOptions.order),
        width: 230,
    },
    {
        title: "修改日期",
        key: "modified_at",
        width: 250,
    },
    statusColumn,
    {
        title: "操作",
        key: "actions",
        render(row: any) {
            return h(
                NButton,
                {
                    size: "small",
                    onClick: () => {
                        const route = router.resolve({
                            name: "DatasetDetail",
                            params: { id: row.cve_id },
                        })
                        window.open(route.href)
                    },
                },
                { default: () => "查看" },
            )
        },
        width: 100,
    },
]
</script>
