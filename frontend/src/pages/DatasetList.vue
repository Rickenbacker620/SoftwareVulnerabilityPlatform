<template lang="pug">
div.space-y-4
    div.flex.flex-row.space-x-2
        NSelect(:options="StatusFilterOptions" @update-value="handleFilterChange" multiple :default-value="['annotated']")
        NInput(placeholder="搜索" v-model:value="queryOptions.q")
    NDataTable(
        remote
        :columns="columns"
        :data="datasets?.list"
        :row-key="(row) => row.cve_id"
        :pagination="pagination"
        :loading="loading"
        @update-page="handlePageChange"
        @update:sorter="handleSorterChange")
</template>

<script setup lang="ts">
import { computed, h, onMounted, reactive, ref, watch, watchEffect } from "vue"
import { NButton, NIcon, NSelect, NCheckbox, NRadioGroup, NRadioButton, c } from "naive-ui"
import { useRouter } from "vue-router"
import { datasetService } from "@/utils/services"
import { CheckmarkFilled, HelpFilled, T, WarningFilled } from "@vicons/carbon"
import { simplifyDate } from "@/utils/others"

const router = useRouter()
const datasets = ref()
const loading = ref(true)


const StatusFilterOptions = [
    { label: "已标注", value: "annotated" },
    { label: "未标注", value: "unannotated" },
    { label: "通过", value: "approved" },
    { label: "未通过", value: "unapproved" },
    { label: "无效", value: "invalid" },
    { label: "有效", value: "valid" },
    { label: "存疑", value: "ambiguous" },
    { label: "示例", value: "example" },
]

const queryOptions = reactive({
    annotated: true,
    ambiguous: undefined,
    approved: undefined,
    invalid: undefined,
    example: undefined,
    order: undefined,
    limit: 10,
    offset: 0,
    q: "",
})

const pagination = reactive({
    page: 1,
    pageCount: 0,
    pageSize: 10,
    itemCount: 0,
    prefix({itemCount}) {
        return `共 ${itemCount} 条`
    }
})


const statusColumn = reactive({
    title: "状态",
    key: "status",
    render(row) {
        const iconArr: any[] = []
        if (row.approved === true) {
            iconArr.push(
                h(
                    NIcon,
                    { color: "#397e36", size: 20 },
                    { default: () => h(CheckmarkFilled) },
                ),
            )
        }
        if (row.ambiguous === true) {
            iconArr.push(
                h(
                    NIcon,
                    { color: "#cab05c", size: 20 },
                    { default: () => h(HelpFilled) },
                ),
            )
        }
        if (row.annotated === true) {
            iconArr.push(
                h(
                    NIcon,
                    { color: "#448faf", size: 20 },
                    { default: () => h(WarningFilled) },
                ),
            )
        }
        return iconArr
    },
    width: 100,
    filter: true,
})

const log = () => {
    console.log(queryOptions.q)
}

watch(queryOptions, async (q, prevQ) => {
    loading.value = true
    datasets.value = await query(q)
    pagination.itemCount = datasets.value?.count ?? 0
    loading.value = false
})


const query = (options) => {
    return datasetService
        .getDatasets(
            options.annotated,
            options.ambiguous,
            options.approved,
            options.invalid,
            options.example,
            options.order,
            options.q,
            options.offset,
            options.limit,
        )
        .then((res) => res.data)
        // .then((data) => {data.list.map(simplifyDate); return data;})
        .then((data) => {
            data.list.map(simplifyDate)
            return data
        })
    // .then((data) => data)
}

const handlePageChange = async (currentPage) => {
    const offset = (currentPage - 1) * queryOptions.limit
    queryOptions.offset = offset
    pagination.page = currentPage
}

const handleSorterChange = async (sorter) => {
    if(sorter.order == false)
        queryOptions.order = undefined
    else if (sorter.order === "ascend")
        queryOptions.order = 0
    else
        queryOptions.order = 1
    console.log(queryOptions.order)
    console.log(sorter)
}

const setDisable = (...options) => {
    for (const option of options) {
        const idx = StatusFilterOptions.findIndex(e => e.value === option)
        StatusFilterOptions[idx]["disabled"] = true
    }
}


const handleFilterChange = async (value, _) => {
    console.log(value)
    const options = StatusFilterOptions.map(e => e.value)
    StatusFilterOptions.forEach(e => e["disabled"] = false)
    queryOptions.annotated = true
    queryOptions.ambiguous = undefined
    queryOptions.approved = undefined
    queryOptions.invalid = undefined
    queryOptions.example = undefined
    for (const option of options) {
        console.log(option)
        if (value.includes(option)) {
            switch (option) {
                case 'annotated':
                    setDisable("unannotated")
                    queryOptions.annotated = true
                    break;
                case 'unannotated':
                    setDisable("annotated", "approved", "unapproved", "invalid", "valid", "ambiguous")
                    queryOptions.annotated = false
                    break;
                case 'approved':
                    setDisable("unapproved")
                    queryOptions.approved = true
                    break;
                case 'unapproved':
                    setDisable("approved")
                    queryOptions.approved = false
                    break;
                case 'valid':
                    setDisable("invalid")
                    queryOptions.invalid = false
                    break;
                case 'invalid':
                    setDisable("valid")
                    queryOptions.invalid = true
                    break;
                case 'ambiguous':
                    queryOptions.ambiguous = true
                    break
                case 'example':
                    queryOptions.example = true
                    break;
                default:
                    break;
            }
        }
    }
}

loading.value = true

onMounted(async () => {
    datasets.value = await query(queryOptions)
    pagination.itemCount = datasets.value?.count ?? 0
    loading.value = false
})

const columns: any[] = [
    {
        title: "CVE编号",
        key: "cve_id",
        width: 150,
        sorter: true,
        sortOrder: computed(() => queryOptions.order),
    },
    {
        title: "修改日期",
        key: "modified_at",
        width: 190
    },
    {
        title: "描述",
        key: "description",
        ellipsis: true,
    },
    statusColumn,
    {
        title: "操作",
        key: "actions",
        render(row: any) {
            return h(
                NButton,
                {
                    size: "small",
                    onClick: () => {
                        const route = router.resolve({
                            name: "DatasetDetail",
                            params: { id: row.cve_id },
                        })
                        window.open(route.href)
                    },
                },
                { default: () => "查看" },
            )
        },
        ellipsis: true,
        width: 150,
    },
]
</script>
