<template lang="pug">
div.container
    NCard.w-96.mx-auto.my-20()
        NTabs(class="card-tabs" default-value="login" size="large" animated)
            NTabPane(name="login" tab="登录")
                NForm
                    NFormItemRow(label="用户名")
                        NInput(placeholder="" v-model:value="model.username")
                    NFormItemRow(label="密码")
                        NInput(type="password" placeholder="" v-model:value="model.password" show-password-on="mousedown")
                NButton(type="primary" @click="login" block secondary strong :loading="loginLoadingRef") 登录
            NTabPane(name="signup" tab="注册")
                NForm
                    NFormItemRow(label="用户名")
                        NInput(placeholder="" v-model:value="model.username")
                    NFormItemRow(label="密码")
                        NInput(type="password" placeholder="" v-model:value="model.password" show-password-on="mousedown")
                    NFormItemRow(label="重复密码")
                        NInput(type="password" placeholder="" v-model:value="model.passwordRepeat" show-password-on="mousedown")
                NButton(type="primary" block secondary strong @click="register") 注册
</template>

<script setup lang="ts">
import { NTabs, NTabPane, NFormItemRow } from "naive-ui"
import { reactive, ref } from "vue"
import { useMessage } from "naive-ui"
import { useRouter } from "vue-router"
import { useUserStore } from "@/stores/user"
import { userService } from "@/utils/services"

const model = reactive({
    username: "",
    password: "",
    passwordRepeat: ""
})

const loginLoadingRef = ref(false)
const registerLoadingRef = ref(false)

const message = useMessage()
const router = useRouter()
const user = useUserStore()

async function f() {
  return new Promise(resolve => {
    setTimeout(function() { resolve(100)}, 5000);
  });
}

const login = async () => {
    try {
        loginLoadingRef.value = true
        await user.login(model.username, model.password)
        message.success("登陆成功")
        router.push("/")
    } catch (error) {
        message.error("登陆失败")
        loginLoadingRef.value = false
    }
}

const register = async () => {
    try {
        registerLoadingRef.value = true
        if (model.password != model.passwordRepeat) {
            throw new Error("nosame");
        }
        userService.register(model.username, model.password)
        message.success("注册成功")
        await user.login(model.username, model.password)
        router.push("/")
    } catch (error: any) {
        if(error.message == "nosame") {
            message.error("两次输入的密码不一致")
        } else {
            message.error("注册失败")
        }
        loginLoadingRef.value = false
    }
}
</script>
