from datetime import datetime

from app.models.dataset import Dataset
from app.models.user import User
from pydantic import BaseModel
from tortoise import fields, models


class Annotation(models.Model):
    start_offset = fields.IntField()
    end_offset = fields.IntField()

    created_at = fields.DatetimeField(null=True, auto_now_add=True)
    modified_at = fields.DatetimeField(null=True, auto_now=True)

    user: fields.ForeignKeyRelation['User'] = fields.ForeignKeyField(
        'models.User',
        on_delete=fields.CASCADE
    )
    dataset: fields.ForeignKeyRelation['Dataset'] = fields.ForeignKeyField(
        'models.Dataset',
        related_name='annotations',
        on_delete=fields.CASCADE,
    )
    part = fields.CharField(max_length=20)
    detail = fields.CharField(max_length=20, null=True)


class AnnotationCreateSchema(BaseModel):
    cve_id: str
    start_offset: int
    end_offset: int
    part: str
    detail: str | None


class AnnotationSchema(BaseModel):
    id: int
    start_offset: int
    end_offset: int
    part: str
    detail: str | None
    created_at: datetime
    modified_at: datetime
    annotated_by: str

    class Config:
        orm_mode = True
