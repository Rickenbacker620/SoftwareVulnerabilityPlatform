from app.core import utils
from pydantic import BaseModel
from tortoise import fields, models


class User(models.Model):
    username = fields.CharField(max_length=20, unique=True)
    password = fields.CharField(max_length=128, null=True)
    role = fields.CharField(max_length=20)

    created_at = fields.DatetimeField(null=True, auto_now_add=True)
    modified_at = fields.DatetimeField(null=True, auto_now=True)

    @classmethod
    async def authenticate(cls, *, username: str, password: str):
        user = await cls.get(username=username)
        if not user:
            return None
        if not utils.verify_password(password, user.password):
            return None
        return user


class UserSchema(BaseModel):
    username: str
    role: str

    class Config:
        orm_mode = True


class UserCreateSchema(BaseModel):
    username: str
    password: str
    role: str
