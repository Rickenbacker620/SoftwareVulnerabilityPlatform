from datetime import datetime

from pydantic import BaseModel
from tortoise import fields, models
from tortoise.contrib.postgres.fields import ArrayField


class CVEInfo(models.Model):
    id = fields.CharField(max_length=40, pk=True)
    description = fields.TextField()
    published_date = fields.DatetimeField()
    last_modified = fields.DatetimeField()
    cvss3_score = fields.CharField(max_length=16, null=True)
    cvss3_type = fields.CharField(max_length=16, null=True)
    cvss2_score = fields.CharField(max_length=16, null=True)
    cvss2_type = fields.CharField(max_length=16, null=True)
    source_link_list = fields.TextField(null=True)
    github_link_list = fields.TextField(null=True)
    cpe_dlist = fields.TextField(null=True)
    cwe_id = fields.CharField(max_length=100, null=True)
    cwe_name = fields.CharField(max_length=200, null=True)


class Dataset(models.Model):
    cve: fields.OneToOneRelation[CVEInfo] = fields.OneToOneField(
        'models.CVEInfo', on_delete=fields.CASCADE)

    created_at = fields.DatetimeField(null=True, auto_now_add=True)
    modified_at = fields.DatetimeField(null=True)

    tags = ArrayField("text")



class DatasetDetailSchema(BaseModel):
    from app.models.annotation import AnnotationOutSchema
    cve_id: str
    description: str
    cwe_id: str | None
    cwe_name: str | None
    tags: list[str] | None
    annotations: list[AnnotationOutSchema] | None
    modified_at: datetime


class DatasetOverviewSchema(BaseModel):
    cve_id: str
    tags: list[str]
    modified_at: datetime

    class Config:
        orm_mode = True


class DatasetListSchema(BaseModel):
    count: int
    list: list[DatasetOverviewSchema]

    class Config:
        orm_mode = True




class StatsSchema(BaseModel):
    user: str
    annotated: int
    total: int
