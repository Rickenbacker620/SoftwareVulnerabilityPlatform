from tortoise import fields, models

from .extra import TimestampMixin
from .project import Project
from .user import User


class CVEInfo(models.Model):
    id = fields.CharField(max_length=32, pk=True)
    cve_no = fields.CharField(max_length=64)
    description = fields.TextField()
    publisheddate = fields.DatetimeField()
    lastmodified = fields.DatetimeField()
    cvss3_score = fields.CharField(max_length=16)
    cvss3_type = fields.CharField(max_length=16)
    cvss2_score = fields.CharField(max_length=16)
    cvss2_type = fields.CharField(max_length=16)
    source_link_list = fields.TextField()
    github_link_lisk = fields.TextField()
    cpe_dlist = fields.TextField()


class Dataset(models.Model, TimestampMixin):
    cve: fields.OneToOneRelation[CVEInfo] = fields.OneToOneField(
        'models.CVEInfo', on_delete=fields.CASCADE)

    project: fields.ForeignKeyRelation[Project] = fields.ForeignKeyField(
        'models.Project',
        on_delete=fields.CASCADE,
        related_name='examples'
    )

    annotations_approved_by: fields.ForeignKeyRelation[User] = fields.ForeignKeyField(
        'models.User',
        on_delete=fields.SET_NULL,
        null=True,
        blank=True
    )


class AnnotationTask(models.Model, TimestampMixin):
    name = fields.CharField(max_length=30)

    user: fields.ForeignKeyRelation[User] = fields.ForeignKeyField(
        'models.User',
        on_delete=fields.SET_NULL,
        null=True,
        blank=True
    )

    dataset: fields.ForeignKeyRelation[Dataset] = fields.ForeignKeyField(
        'models.Dataset',
        on_delete=fields.SET_NULL,
        null=True,
        blank=True
    )

    done = fields.BooleanField(default=False)
