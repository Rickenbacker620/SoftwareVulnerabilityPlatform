import json
from tempfile import tempdir
from pydantic import Json
from base import *
import csv
import spacy

# nlp = spacy.load("en_core_web_sm")

# file = open("file20220303-new.csv", "w")
# writer = csv.DictWriter(file, fieldnames=["CVE", "CWE", "CWE_NAME","description","cause_v", "cause_n"])
# writer.writeheader()
# for dataset in approved_datasets:
#     temp_dict = {}
#     ds = Dataset(dataset)
#     for index, cause in enumerate(ds["cause"]):
#         doc = nlp(ds.description[cause.start_offset: cause.end_offset])
#         if (doc[0].pos_ == "VERB" or doc[0].text in ["do", "does", "did"]):
#             temp_dict["cause_v"] = ds.description[cause.start_offset: cause.end_offset]
#         else:
#             temp_dict["cause_n"] = ds.description[cause.start_offset: cause.end_offset]

#     temp_dict["CVE"] = ds.cve_id
#     temp_dict["CWE"] = ds.cwe_id
#     temp_dict["CWE_NAME"] = ds.cwe_name
#     temp_dict["description"] = ds.description
#     writer.writerow(temp_dict)


# file = open("file20220304.csv", "w")
# writer = csv.DictWriter(file, fieldnames=["CVE", "CWE", "description","description11","description12", "description21", "description22"])
# writer.writeheader()
# for dataset in approved_datasets:
#     temp_dict = {}
#     ds = Dataset(dataset)
#     annotation_text1 = []
#     annotation_text2 = []
#     for index, annotation in enumerate(ds.annotations):
#         annotation_text1.append(ds.description[annotation.start_offset: annotation.end_offset])
#         if annotation.part not in ["location", "version"]:
#             annotation_text2.append(ds.description[annotation.start_offset: annotation.end_offset])
#     annotation_text11 = ",".join(annotation_text1)
#     annotation_text12 = "\t".join(annotation_text1)
#     annotation_text21 = ",".join(annotation_text2)
#     annotation_text22 = "\t".join(annotation_text2)

#     temp_dict["CVE"] = ds.cve_id
#     temp_dict["CWE"] = ds.cwe_id
#     temp_dict["description"] = ds.description
#     temp_dict["description11"] = annotation_text11
#     temp_dict["description12"] = annotation_text12
#     temp_dict["description21"] = annotation_text21
#     temp_dict["description22"] = annotation_text22
#     writer.writerow(temp_dict)

# file = open("file20220306.jsonl", "w")
# for dataset in approved_datasets:

#     ds = Dataset(dataset)
#     splt = ds.description.split(". ")
#     idx = 0
#     for sentence in splt:

#         temp_dict = {}
#         temp_dict["CVE"] = ds.cve_id
#         temp_dict["description"] = sentence
#         temp_dict["annotations"] = []

#         start = ds.description.find(sentence)
#         end = start + len(sentence)

#         for cause in ds["cause"]:
#             if cause.start_offset >= start and cause.end_offset <= end:
#                 cause.start_offset = cause.start_offset - start
#                 cause.end_offset = cause.end_offset - start
#                 temp_dict["annotations"].append(cause.dict())
#                 if idx > 1:
#                     print(ds.cve_id)
#                     print(sentence[cause.start_offset: cause.end_offset])
#         idx += 1
#         to_write = json.dumps(temp_dict)
#         file.write(to_write + "\n")



# file = open("file20220308-operation-before-situation.jsonl", "w")
# for dataset in approved_datasets:
#     ds = Dataset(dataset)
#     situation = ds["situation"]
#     operation = ds["operation"]
#     if situation != [] and operation != []:
#         if situation[0].start_offset > operation[0].end_offset:
#             file.write(ds.cve_id + "\n")


# file = open("file20220308-UNK.jsonl", "w")
# for dataset in approved_datasets:
#     ds = Dataset(dataset)
#     cause = ds["cause"]
#     if cause:
#         detail = None
#         for c in cause:
#             if c.detail:
#                 detail = c.detail

#         for c in cause:
#             if c.detail != detail:
#                 c.detail = detail
#     ds.save_annotations()

# f = open("outputs/20220309.csv", "w")
# writer = csv.DictWriter(f, fieldnames=["cve", "description", "cause1", "cause2", "cause_type"])
# writer.writeheader()
# for dataset in approved_datasets:
#     ds = Dataset(dataset)
#     cve_id = ds.cve_id
#     description = ds.description
#     if len(ds["cause"]) == 1:
#         cause1 = ds["cause"][0]
#         cause2 = None
#         cause1 = ds.description[cause1.start_offset: cause1.end_offset]
#         cause_type = ds["cause"][0].detail
#     elif len(ds["cause"]) == 2:
#         cause1 = ds["cause"][0]
#         cause2 = ds["cause"][1]
#         cause1 = ds.description[cause1.start_offset: cause1.end_offset]
#         cause2 = ds.description[cause2.start_offset: cause2.end_offset]
#         cause_type = ds["cause"][0].detail
#     else:
#         cause1 = None
#         cause2 = None
#         cause_type = None

#     temp_dict = {
#         "cve": cve_id,
#         "description": description,
#         "cause1": cause1,
#         "cause2": cause2,
#         "cause_type": cause_type
#     }
#     writer.writerow(temp_dict)

# des96 = open("inputs/new-96.txt","r").readlines()
# des114 = open("inputs/new-114.txt","r").readlines()
# # devall = open("inputs/dev.txt","r").readlines()


# cves = [line.split(" ")[0] for line in des96 if line != "\n"]
# cves = [line[4:] for line in cves if not line.startswith("NULL")]
# cves = set(cves)
# with open("outputs/96cve.txt", "w") as file:
#     for cve in cves:
#         file.write(cve + "\n")


# cves = [line.split(" ")[0] for line in des114 if line != "\n"]
# cves = [line[4:] for line in cves if not line.startswith("NULL")]
# cves = set(cves)
# with open("outputs/114cve.txt", "w") as file:
#     for cve in cves:
#         file.write(cve + "\n")

file = open("20220310.csv", "w")
causes = ["cause1","cause2", "type"]
others  = [cat for cat in Dataset._categories if cat != "cause"]
writer = csv.DictWriter(file, fieldnames=["cve_id", "cwe_id", "cwe_name", "description"] + causes + others)
writer.writeheader()


for dataset in approved_datasets:
    ds = Dataset(dataset)
    tempdict = {}
    tempdict["cve_id"] = ds.cve_id
    tempdict["description"] = ds.description
    tempdict["cwe_id"] = ds.cwe_id
    tempdict["cwe_name"] = ds.cwe_name
    for index, cause in enumerate(ds["cause"]):
        tempdict["cause" + str(index + 1)] = cause.get_text(ds.description)
        tempdict["type"] = cause.detail
    for cat in ds._categories:
        if cat == "cause":
            continue
        if len(ds[cat]) >= 1:
            tempdict[cat] = ds[cat][0].get_text(ds.description)
    writer.writerow(tempdict)