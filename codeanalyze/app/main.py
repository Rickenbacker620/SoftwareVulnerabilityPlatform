import subprocess
import os
from fastapi import FastAPI, UploadFile
from fastapi.staticfiles import StaticFiles
import uvicorn

ROOT_PATH = "app/uploadcode/"

app = FastAPI(debug=True)

app.mount("/analyze", StaticFiles(directory=ROOT_PATH + "output_results"), name="analyze")

@app.post("/process_code/")
async def process_code(
    file: UploadFile
):
    for i in os.listdir(ROOT_PATH + "input_codes/"):
        os.remove(ROOT_PATH + f"/input_codes/{i}")
    with open(ROOT_PATH + f"input_codes/{file.filename}", "wb") as save_file:
        save_file.write(await file.read())
        await file.close()
    ret = subprocess.run([ROOT_PATH + "batch.sh"])
    return ret.returncode

if __name__ == "__main__":
    uvicorn.run("main:app", host="0.0.0.0", port=8000, reload=True)