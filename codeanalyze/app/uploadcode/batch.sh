#! /bin/bash
cd "${0%/*}"

input_path="./input_codes"
output_path="./output_results"

rm -rf $output_path/*
mkdir $output_path/bin
mkdir $output_path/graphs
mkdir $output_path/processed
mkdir $output_path/zipped

joern-parse $input_path -o $output_path/bin/cpg.bin

joern-export $output_path/bin/cpg.bin --repr ast --out $output_path/graphs/ast
joern-export $output_path/bin/cpg.bin --repr cfg --out $output_path/graphs/cfg
joern-export $output_path/bin/cpg.bin --repr ddg --out $output_path/graphs/ddg
joern-export $output_path/bin/cpg.bin --repr cdg --out $output_path/graphs/cdg
joern-export $output_path/bin/cpg.bin --repr pdg --out $output_path/graphs/pdg
joern-export $output_path/bin/cpg.bin --repr cpg14 --out $output_path/graphs/cpg

for graph_dir in $output_path/graphs/*; do
    dir=$(basename $graph_dir)
    dot_file=${graph_dir}/1-${dir}.dot
    png_file=$(basename $dot_file .dot).png
    dot -Tpng -o $output_path/processed/$png_file $dot_file
done

tar zcvf $output_path/zipped/output.tar.gz -C $output_path/graphs/ .
